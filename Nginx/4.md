ğŸ˜¶â€ğŸŒ«ï¸[Nginxå®˜ç½‘åœ°å€](https://www.nginx.org)

> â¤ï¸â¤ï¸ğŸ’•ğŸ’•ğŸ¾ğŸ¾

ğŸ˜¶â€ğŸŒ«ï¸[æˆ‘çš„å­¦ä¹ ç¬”è®°ï¼ˆgithub)](https://github.com/3293172751/CS_COURSE)

---

**åŒºå—é“¾æŠ€æœ¯ï¼ˆä¹Ÿç§°ä¹‹ä¸ºåˆ†å¸ƒå¼è´¦æœ¬æŠ€æœ¯ï¼‰**ï¼Œæ˜¯ä¸€ç§äº’è”ç½‘æ•°æ®åº“æŠ€æœ¯ï¼Œå…¶ç‰¹ç‚¹æ˜¯å»ä¸­å¿ƒåŒ–ï¼Œå…¬å¼€é€æ˜ï¼Œè®©æ¯ä¸€ä¸ªäººå‡å¯å‚ä¸çš„æ•°æ®åº“è®°å½•

>   â¤ï¸ğŸ’•ğŸ’•å…³äºåŒºå—é“¾æŠ€æœ¯ï¼Œå¯ä»¥å…³æ³¨æˆ‘ï¼Œå…±åŒå­¦ä¹ æ›´å¤šçš„åŒºå—é“¾æŠ€æœ¯ã€‚åšå®¢[http://nsddd.top](http://nsddd.top)

---

# Nginxä¸­çš„é…ç½®æ–‡ä»¶

[toc]

### ç›®å½•åœ°å€ï¼š

```shell
[root@mail nginx]# cd conf/
[root@mail conf]# ls
enable-php-00.conf  enable-php-72.conf  enable-php-90.conf      koi-win             rewrite
enable-php-52.conf  enable-php-73.conf  enable-php-91.conf      luawaf.conf         scgi_params
enable-php-53.conf  enable-php-74.conf  enable-php.conf         mime.types          scgi_params.default
enable-php-54.conf  enable-php-80.conf  fastcgi.conf            mime.types.default  uwsgi_params
enable-php-55.conf  enable-php-81.conf  fastcgi.conf.default    nginx.conf          uwsgi_params.default
enable-php-56.conf  enable-php-82.conf  fastcgi_params          nginx.conf.default  vhost
enable-php-70.conf  enable-php-83.conf  fastcgi_params.default  pathinfo.conf       win-utf
enable-php-71.conf  enable-php-84.conf  koi-utf                 proxy.conf
[root@mail conf]# vim nginx.conf
```

### ç»“æ„ï¼š

> ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆ
>
> ç¬¬ä¸€éƒ¨åˆ†ï¼šå…¨å±€å—
>
> ç¬¬äºŒéƒ¨åˆ†ï¼ševentså—
>
> ç¬¬ä¸‰éƒ¨åˆ†ï¼šhttpå—**(é…ç½®æœ€é¢‘ç¹çš„éƒ¨åˆ†ï¼‰**

```
worker_processes auto;
```

**è¿™ä¸ªæ˜¯NginxæœåŠ¡å™¨å¹¶å‘å¤„ç†æœåŠ¡çš„å…³é”®é…ç½®ï¼Œå€¼è¶Šå¤§ï¼Œè¡¨ç¤ºå¯ä»¥æ”¯æŒçš„å’Œå¹¶å‘å¤„ç†é‡è¶Šå¤šprocesses ï¼šè¿‡ç¨‹**

```
worker_connections 51200;   
```

**è¡¨ç¤ºæ”¯æŒçš„æœ€å¤§è¿æ¥æ•°**



**å…¨å±€å—ï¼šä¸»è¦æ˜¯è®¾ç½®ä¸€äº›å½±å“nginxæ•´ä½“æœåŠ¡è¿è¡Œçš„é…ç½®æœåŠ¡**

```
user  www www;
worker_processes auto;
error_log  /www/wwwlogs/nginx_error.log  crit;
pid        /www/server/nginx/logs/nginx.pid;
worker_rlimit_nofile 51200;
```



```shell
user  www www;
#nginxçš„å¯åŠ¨ç”¨æˆ·
worker_processes auto;
#workerè¿™ä¸ªæ˜¯å¯åŠ¨çš„æ•°ç›®ï¼Œå¯¹åº”çš„cpuå†…æ ¸æ•°
error_log  /www/wwwlogs/nginx_error.log  crit;
pid        /www/server/nginx/logs/nginx.pid;
worker_rlimit_nofile 51200;

events
    {
        use epoll; 
        worker_connections 51200;   #è¡¨ç¤ºæ”¯æŒçš„æœ€å¤§è¿æ¥æ•°
        multi_accept on;
    }

http
    {
        include       mime.types;
		#include luawaf.conf;
		#å¤´æ–‡ä»¶ï¼ŒåŒ…å«å…¶ä»–çš„æ–‡ä»¶   mime.typesæ˜¯æ–‡ä»¶ç±»å‹ï¼Œä¼ è¾“httpæ•°æ®çš„æ—¶å€™ï¼Œä¼šåœ¨é‡Œé¢åŠ å…¥type,å¦åˆ™æµè§ˆå™¨ä¸çŸ¥é“æ€ä¹ˆè§£ææ–‡ä»¶ç±»å‹

		#sendifile on;
        
		include proxy.conf;
	
		
        default_type  application/octet-stream;

        server_names_hash_bucket_size 512;
        client_header_buffer_size 32k;
        large_client_header_buffers 4 32k;
        client_max_body_size 50m;

        sendfile   on;
        tcp_nopush on;

        keepalive_timeout 60;
        #ä¿æŒè¿æ¥

        tcp_nodelay on;

        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
        fastcgi_buffer_size 64k;
        fastcgi_buffers 4 64k;
        fastcgi_busy_buffers_size 128k;
        fastcgi_temp_file_write_size 256k;
		fastcgi_intercept_errors on;

        gzip on;
        gzip_min_length  1k;
        gzip_buffers     4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_types     text/plain application/javascript application/x-javascript text/javascript text/css application/xml;
        gzip_vary on;
        gzip_proxied   expired no-cache no-store private auth;
        gzip_disable   "MSIE [1-6]\.";

        limit_conn_zone $binary_remote_addr zone=perip:10m;
		limit_conn_zone $server_name zone=perserver:10m;

        server_tokens off;
        access_log off;

#æ¯ä¸€ä¸ªæœåŠ¡ï¼Œä¸€ä¸ªnginxå¯ä»¥å¼€å¤šä¸ªä¸»æœº
#æ‰€ä»¥å«è™šæ‹Ÿä¸»æœºã€‚vhost
server
    {
        listen 888;
     	#ä¸åŒçš„serveçš„ç«¯å£ä¸ä¸€æ ·
     	server_name phpmyadmin; #åŸŸåã€ä¸»æœºåç§°ï¼ˆlocalhostï¼‰
        index index.html index.htm index.php;
        root  /www/server/phpmyadmin;
            location ~ /tmp/ {
                return 403;
            }

        #error_page   404   /404.html;
        include enable-php.conf;

        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
        {
        #åŸŸååè·Ÿç€å­ç›®å½•æˆ–è€…lu
            expires      30d;
        }

        location ~ .*\.(js|css)?$
        {
            expires      12h;
        }

        location ~ /\.
        {
            deny all;
        }
		
		error_page 500 502 503 504 /50x.html;
		#å¦‚æœæŠ¥é”™çš„è¯ï¼Œå°±æŠ¥500 502ï¼Œè€Œä¸”é”™è¯¯æ–‡ä»¶åœ¨50.htmlä¸­ 
		
        access_log  /www/wwwlogs/access.log;
    }
include /www/server/panel/vhost/nginx/*.conf;
}
```



#### httpå—

**httpå—å¯ä»¥åŒ…æ‹¬httpå—ã€serverå—**

```
http
    {
        include       mime.types;
		#include luawaf.conf;

		include proxy.conf;

        default_type  application/octet-stream;

        server_names_hash_bucket_size 512;
        client_header_buffer_size 32k;
        large_client_header_buffers 4 32k;
        client_max_body_size 50m;

        sendfile   on;
        tcp_nopush on;

        keepalive_timeout 60;

        tcp_nodelay on;

        fastcgi_connect_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_read_timeout 300;
        fastcgi_buffer_size 64k;
        fastcgi_buffers 4 64k;
        fastcgi_busy_buffers_size 128k;
        fastcgi_temp_file_write_size 256k;
		fastcgi_intercept_errors on;

        gzip on;
        gzip_min_length  1k;
        gzip_buffers     4 16k;
        gzip_http_version 1.1;
        gzip_comp_level 2;
        gzip_types     text/plain application/javascript application/x-javascript text/javascript text/css application/xml;
        gzip_vary on;
        gzip_proxied   expired no-cache no-store private auth;
        gzip_disable   "MSIE [1-6]\.";

        limit_conn_zone $binary_remote_addr zone=perip:10m;
		limit_conn_zone $server_name zone=perserver:10m;

        server_tokens off;
        access_log off;
```



# é…ç½® HTTPS

é¦–å…ˆé…ç½®æ”¯æŒ HTTPS å¿…é¡»è®© Nginx å¼€å¯ `http_ssl_module` æ¨¡å—ï¼Œ[ç‚¹å‡»æŸ¥çœ‹nginxç¼–è¯‘å®‰è£…å‚æ•°](https://xuexb.github.io/learn-nginx/guide/nginx-configure-descriptions.html) ï¼Œå¯ä»¥ä½¿ç”¨`nginx -V`æŸ¥çœ‹æ˜¯å¦å¼€å¯`TLS SNI support enabled`ã€‚

è´­ä¹°/ç”Ÿæˆ SSL è¯ä¹¦ï¼Œå¯ä»¥ä½¿ç”¨å…è´¹çš„è¯ä¹¦ï¼Œæ¯”å¦‚ï¼š[Let's Encryptï¼Œå…è´¹å¥½ç”¨çš„ HTTPS è¯ä¹¦](https://imququ.com/post/letsencrypt-certificate.html) ã€‚

```bash
# é…ç½® HTTPS

# é…ç½®ä¸ªhttpçš„ç«™ç‚¹ï¼Œç”¨æ¥åšé‡å®šå‘ï¼Œå½“ç„¶å¦‚æœä½ ä¸éœ€è¦æŠŠ HTTP->HTTPS å¯ä»¥æŠŠè¿™ä¸ªé…ç½®åˆ äº†
server {
    listen       80;

    # é…ç½®åŸŸå
    server_name www.xxoo.com xxoo.com;

    # æ·»åŠ  STS, å¹¶è®©æ‰€æœ‰å­åŸŸæ”¯æŒ, å¼€å¯éœ€æ…é‡
    add_header strict-transport-security 'max-age=31536000; includeSubDomains; preload';

    # é…ç½®è®©è¿™äº› HTTP çš„è®¿é—®å…¨éƒ¨ 301 é‡å®šå‘åˆ° HTTPS çš„
    rewrite ^(.*) https://www.xxoo.com$1 permanent;
}

# é…ç½® HTTPS
server {
    # é…ç½®åŸŸå
    server_name www.xxoo.com xxoo.com;

    # httpsé»˜è®¤ç«¯å£
    listen 443;

    # æ·»åŠ STS, å¹¶è®©æ‰€æœ‰å­åŸŸæ”¯æŒ, å¼€å¯éœ€æ…é‡
    add_header strict-transport-security 'max-age=31536000; includeSubDomains; preload';

    # httpsé…ç½®
    ssl on;
    ssl_certificate /xxoo/www.xxoo.com.crt;
    ssl_certificate_key /xxoo/www.xxoo.com.key;

    # å…¶ä»–æŒ‰æ­£å¸¸é…ç½®å¤„ç†å³å¯...
}
```

> æ³¨æ„ï¼Œè¿™é‡Œè¯ä¹¦çš„æ ¼å¼æ˜¯ `.crt` çš„ã€‚

### [#](https://xuexb.github.io/learn-nginx/example/https.html#é…ç½®åçš„è®¿é—®è§„åˆ™)é…ç½®åçš„è®¿é—®è§„åˆ™

| è¾“å…¥é“¾æ¥                    | æœ€ç»ˆè®¿é—®é“¾æ¥                 |
| --------------------------- | ---------------------------- |
| http://www.xxoo.com         | https://www.xxoo.com         |
| http://www.xxoo.com/404/500 | https://www.xxoo.com/404/500 |
| http://xxoo.com             | https://www.xxoo.com         |
| https://www.xxoo.com        | -ï¼ˆåŸé“¾æ¥ä¸å˜ï¼‰              |
| https://xxoo.com/500        | https://www.xxoo.com/500     |

